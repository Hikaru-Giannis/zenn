---
title: "Laravelのサービスプロバイダを解剖する"
emoji: "📘"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## サービスプロバイダについて
Laravelのサービスプロバイダとは、Laravelアプリケーションのサービスコンテナにサービスをバインドし、設定やイベントリスナーを登録するクラスです。
例えばデータベースのサービスプロバイダの場合、さまざまな接続を解決するために使われるデータベース・マネージャーを登録していたりしています。

サービスプロバイダの利点はさまざまありますが、個人的には次の2つが大きいと思います。
- 依存性管理を簡素化できる
- 初期化プロセスが必要になる場合、一元で管理し、実行できる

## registerメソッドについて
サービスプロバイダには、`register`メソッドが提供されています。
この関数はサービスコンテナへのサービスのバインディングに特化しています。

例えばRepositoryパターンを採用している場合、そのインタフェースと実装クラスを次のように登録することが可能です。

```php
/**
 * Register any application services.
 */
public function register(): void
{
    $this->app->bind(
        \App\Models\PostRepository::class,
        \App\Repositories\Post\EloquentRepository::class
    );
}
```

## bootメソッドについて
次に、`boot`メソッドについて解説します。
こちらは、全てのプロバイダが登録を終えてから実行されます。
特定の初期処理が必要な場合は、ここに記述する必要があります。
例えばUserモデルのイベントを監視したい場合に、Observerを利用するとします。
その場合は、次のコードで登録することが可能です。

```php
public function boot(): void
{
    User::observe(\App\Observers\UserObserver::class);
}
```

## デフォルトのサービスプロバイダ
ここでは、Laravel側が事前に定義しているサービスプロバイダについて解説します。
Laravel側で事前に定義しているサービスプロバイダは次のようなものがあります。

```php
// DefaultProviders の一部
/**
 * Create a new default provider collection.
 *
 * @return void
 */
public function __construct(?array $providers = null)
{
    $this->providers = $providers ?: [
        \Illuminate\Auth\AuthServiceProvider::class,
        \Illuminate\Broadcasting\BroadcastServiceProvider::class,
        \Illuminate\Bus\BusServiceProvider::class,
        \Illuminate\Cache\CacheServiceProvider::class,
        \Illuminate\Foundation\Providers\ConsoleSupportServiceProvider::class,
        \Illuminate\Cookie\CookieServiceProvider::class,
        \Illuminate\Database\DatabaseServiceProvider::class,
        \Illuminate\Encryption\EncryptionServiceProvider::class,
        \Illuminate\Filesystem\FilesystemServiceProvider::class,
        \Illuminate\Foundation\Providers\FoundationServiceProvider::class,
        \Illuminate\Hashing\HashServiceProvider::class,
        \Illuminate\Mail\MailServiceProvider::class,
        \Illuminate\Notifications\NotificationServiceProvider::class,
        \Illuminate\Pagination\PaginationServiceProvider::class,
        \Illuminate\Pipeline\PipelineServiceProvider::class,
        \Illuminate\Queue\QueueServiceProvider::class,
        \Illuminate\Redis\RedisServiceProvider::class,
        \Illuminate\Auth\Passwords\PasswordResetServiceProvider::class,
        \Illuminate\Session\SessionServiceProvider::class,
        \Illuminate\Translation\TranslationServiceProvider::class,
        \Illuminate\Validation\ValidationServiceProvider::class,
        \Illuminate\View\ViewServiceProvider::class,
    ];
}
```

その他に、次のプロバイダーも事前に登録されています。

```php
// config/app.php の一部
'providers' => ServiceProvider::defaultProviders()->merge([
    /*
      * Package Service Providers...
      */

    /*
      * Application Service Providers...
      */
    App\Providers\AppServiceProvider::class,
    App\Providers\AuthServiceProvider::class,
    // App\Providers\BroadcastServiceProvider::class,
    App\Providers\EventServiceProvider::class,
    App\Providers\RouteServiceProvider::class,
])->toArray(),
```

その中から`RouteServiceProvider`をのぞいてみます。

```php
class RouteServiceProvider extends ServiceProvider
{
    /**
     * The path to your application's "home" route.
     *
     * Typically, users are redirected here after authentication.
     *
     * @var string
     */
    public const HOME = '/home';

    /**
     * Define your route model bindings, pattern filters, and other route configuration.
     */
    public function boot(): void
    {
        RateLimiter::for('api', function (Request $request) {
            return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
        });

        $this->routes(function () {
            Route::middleware('api')
                ->prefix('api')
                ->group(base_path('routes/api.php'));

            Route::middleware('web')
                ->group(base_path('routes/web.php'));
        });
    }
}
```

ここでは、register()メソッドは書いておらず、boot()メソッドが実装されています。

実装内容としては、RateLimiter::forを使用して、APIのレート制限を設定しています。
次に、$this->routesメソッドを使用して、アプリケーションのルートを定義しています。ここでは、apiとwebの2つのルートグループが定義されています。
apiルートグループは、apiミドルウェアを使用し、apiというプレフィックスが付けられ、routes/api.phpファイルに定義されています。
webルートグループは、webミドルウェアを使用し、routes/web.phpファイルに定義されています

要するにアプリケーションのルーティングに関する初期処理がここでは記述されていることが分かります。

## カスタムサービスプロバイダ
ここでは、カスタムサービスプロバイダについて解説します。

CollectionMacroのコード例

## 遅延プロバイダとは
ここでは、遅延プロバイダについて解説します。

TODO Laravel10を想定

## 最後に

## 参考URL
